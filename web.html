<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WSI Image Prediction and Segmentation</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-image: url('背景图2.jpeg'); 
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        
        div {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 10px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .container, .upload-container, .image-container {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 10px;
            width: 700px; /* 设置统一的最大宽度 */
            margin-left: auto; 
            margin-right: auto; 
            text-align: center; 
        }

        .upload-container {
            border: 2px dashed #ccc;
            padding: 40px;
            margin-bottom: 30px;
            max-width: 600px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }

        .upload-container:hover {
            background-color: #e9ecef;
        }

        .upload-container label {
            margin-top: 10px;
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
        }

        .upload-container input[type="file"] {
            display: none;
        }

        #previewImage {
            max-width: 300px;
            height: auto;
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 5px;
        }

        progress {
            width: 100%;
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        #image-container {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            width: 100%;
            max-width: 700px; /* Limit the maximum width of the image containers */
        }

        #image-container div {
            flex: 1;
            margin: 0 10px;
            text-align: center;
        }

        #image-container h2 {
            margin-bottom: 10px;
        }

        #image-container img {
            max-width: 300px; 
            height: auto;  
            border: 1px solid #ddd;
            padding: 5px;
        }
    </style>
</head>
<body>
  <div class="container">
    <h1>WSI Image Prediction and Segmentation</h1>
    <!-- 其他页面内容，如上传区域、图片显示区域等，也可以放在这里 -->
  </div>
  <!-- 图片上传区域 -->
  <div class="container" id="uploadContainer">
  <div class="upload-container" >
      <label for="uploadWSI" id="uploadLabel">
          <p>Click here to upload</p>
          <p><small>By using this online service you agree that the data can be used to improve the model!</small></p>
      </label>
      <!-- 文件输入框，用于选择要上传的图片文件 -->
      <input type="file" id="uploadWSI" accept="image/*" />
      <img id="previewImage" src="" alt="Preview" style="display: none;"> <!-- 图片预览 -->
      <progress id="uploadProgress" value="0" max="100" style="display: none;"></progress> <!-- 上传进度条 -->
  </div>
  </div>
  <!-- 按钮：开始处理数据 -->
  <button id="processButton">Process Data</button>

  <!-- 图像显示容器 -->
  <div id="image-container" style="display: none;">
      <div id="predictionContainer">
          <h2>Prediction</h2>
          <img id="predictionImage" src="" alt="Prediction Image" />
      </div>
      <div id="segmentationContainer">
          <h2>Segmentation</h2>
          <img id="segmentationImage" src="" alt="Segmentation Image" />
      </div>
  </div>

  <!-- 按钮：重新上传 -->
  <button id="uploadAgainButton" style="display: none;">Upload Again</button>

  <script>
      const uploadInput = document.getElementById('uploadWSI');
      const uploadLabel = document.getElementById('uploadLabel');
      const previewImage = document.getElementById('previewImage');
      const uploadProgress = document.getElementById('uploadProgress');
      const processButton = document.getElementById('processButton');
      const imageContainer = document.getElementById('image-container');
      const uploadAgainButton = document.getElementById('uploadAgainButton');
      let imageDataUrl;

      // 更新上传进度条和预览图片
      uploadInput.addEventListener('change', function() {
          const file = this.files[0];
          if (file) {
              uploadProgress.style.display = 'block'; // 显示进度条
              
              
              // 读取文件并更新进度条
              const reader = new FileReader();
              reader.onprogress = function(event) {
                  if (event.lengthComputable) {
                      const max = event.total;
                      const current = event.loaded;
                      const percentage = Math.floor((current * 100) / max);
                      uploadProgress.value = percentage;
                  }
              };
              reader.onload = function(event) {
                  imageDataUrl = event.target.result;
                  uploadProgress.style.display = 'none';// 当文件被读取完成，隐藏进度条
                  uploadLabel.style.display = 'none';
                  previewImage.src = imageDataUrl; // 创建图片预览
                  previewImage.style.display = 'block'; // 显示预览图片
              };
              
              reader.readAsDataURL(file); // 读取文件为DataURL
          }
      });

      // 处理按钮点击事件
      processButton.addEventListener('click', function() {
          if (uploadInput.files[0]) {
              this.style.display = 'none'; // 隐藏处理按钮
              uploadContainer.style.display = 'none';
              uploadProgress.style.display = 'none'; 
              
              
              // 当文件被读取为DataURL后，开始处理图片
              processImage(imageDataUrl).then(processedImageUrl => {
                  // 处理完成，显示结果和上传按钮
                  imageContainer.style.display = 'block';
                  document.getElementById('predictionImage').src = processedImageUrl;
                  document.getElementById('segmentationImage').src = processedImageUrl;
                  uploadAgainButton.style.display = 'block';
              }).catch(error => {
                  console.error('Error processing image:', error);
              });
              
          }
      });

      // 重新上传按钮点击事件
      uploadAgainButton.addEventListener('click', function() {
          this.style.display = 'none'; // 隐藏重新上传按钮
          uploadContainer.style.display = 'block';
          uploadLabel.style.display = 'block';
          imageContainer.style.display = 'none'; // 隐藏结果容器
          processButton.style.display = 'block'; // 显示处理按钮
          uploadProgress.value = 0; // 重置进度条
          uploadProgress.style.display = 'none'; // 隐藏进度条
          previewImage.src = ""; // 清除预览图片
          previewImage.style.display = 'none'; // 隐藏预览图片
          uploadInput.value = null; // 清空文件输入
      });

      // 假设processImage函数为反转图片颜色的函数
      function processImage(imageDataUrl) {
          return new Promise((resolve, reject) => {
              const image = new Image();
              image.crossOrigin = 'Anonymous'; // 如果图片跨域，需要设置这个属性

              image.onload = function() {
                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');
                  canvas.width = image.width;
                  canvas.height = image.height;
                  ctx.drawImage(image, 0, 0);

                  // 获取图像数据并进行颜色反转
                  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                  const data = imageData.data;
                  for (let i = 0; i < data.length; i += 4) {
                      data[i] = 255 - data[i];     // 反转红色
                      data[i + 1] = 255 - data[i + 1]; // 反转绿色
                      data[i + 2] = 255 - data[i + 2]; // 反转蓝色
                  }
                  ctx.putImageData(imageData, 0, 0);

                  // 将canvas转换为Blob，然后转换为DataURL
                  canvas.toBlob(function(blob) {
                      const reader = new FileReader();
                      reader.onloadend = function() {
                          resolve(reader.result); // 返回反转颜色后的图片DataURL
                      };
                      reader.readAsDataURL(blob);
                  }, 'image/png');
              };

              image.onerror = function() {
                  reject('Image load error'); // 图片加载失败时调用reject
              };

              image.src = imageDataUrl;
          });
      }
  // 网站搞好看一点
  // 要能打开和预览tiff文件还有压缩包，要预览的话可以将tiff转化为png或者通过canvas = tiff.toCanvas()函数来展示；可以放到一个服务器中
  // 上传的图片可以选择是压缩包还是.tif文件
  // 图片保存到一个变量x中，再调用两次处理函数得到两个结果
  // 图片处理过程要有进度条，类似照片中的过程，处理过程可以用javascript div clear之类的功能隐藏输入框
  // 如果有空的话，可以用类似getxyonclick的函数获得鼠标位置，然后根据此位置圈出一个小框，只处理这个框中的内容
  </script>
</body>
</html>
